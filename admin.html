<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Servis Paneli - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --card-bg: rgba(15, 23, 42, 0.98);
      --accent: #4f46e5;
      --danger: #ef4444;
      --muted: #9ca3af;
      --border: #1f2937;
      --text: #f9fafb;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#111827 0,#020617 55%,#000 100%);
      color:var(--text);min-height:100vh;display:flex;justify-content:center;padding:24px;
    }
    .app{
      width:100%;max-width:1200px;
      background:linear-gradient(145deg,rgba(15,23,42,0.98),rgba(15,23,42,0.95));
      border-radius:32px;border:1px solid rgba(148,163,184,0.18);
      padding:20px 22px 24px;box-shadow:0 18px 40px rgba(15,23,42,0.65);
      display:flex;flex-direction:column;gap:16px;position:relative;overflow:hidden;
    }
    .app-header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 12px 6px;border-radius:20px;
      background:radial-gradient(circle at top left,rgba(79,70,229,0.2),transparent 55%),rgba(15,23,42,0.96);
      border:1px solid rgba(99,102,241,0.4);position:relative;overflow:hidden;
    }
    .brand{display:flex;align-items:center;gap:12px;position:relative;z-index:1;}
    .brand-logo{
      width:38px;height:38px;border-radius:14px;
      background:conic-gradient(from 200deg,#4f46e5,#22c55e,#ec4899,#4f46e5);
      display:inline-flex;align-items:center;justify-content:center;
    }
    .brand-logo span{font-weight:700;font-size:17px;}
    .brand-text{display:flex;flex-direction:column;gap:2px;}
    .brand-title{font-size:18px;font-weight:600;display:flex;align-items:center;gap:6px;}
    .brand-pill{
      font-size:11px;padding:2px 7px;border-radius:999px;
      border:1px solid rgba(248,250,252,0.6);text-transform:uppercase;
    }
    .brand-subtitle{font-size:12px;color:var(--muted);}
    .header-right{display:flex;align-items:center;gap:10px;font-size:12px;z-index:1;}
    .badge-online{
      display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(34,197,94,0.8);background:rgba(22,163,74,0.15);
    }
    .dot{width:8px;height:8px;border-radius:999px;background:#22c55e;}
    .admin-tag{
      padding:5px 9px;border-radius:999px;border:1px solid rgba(148,163,184,0.8);
      background:rgba(15,23,42,0.9);
    }
    .grid{
      display:grid;grid-template-columns:minmax(0,1.2fr) minmax(0,1.6fr);
      gap:14px;margin-top:4px;
    }
    @media(max-width:980px){.grid{grid-template-columns:1fr;}}
    .card{
      border-radius:22px;background:var(--card-bg);
      border:1px solid var(--border);padding:14px 14px 16px;
    }
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
    .card-title{font-size:14px;text-transform:uppercase;letter-spacing:.04em;display:flex;align-items:center;gap:8px;}
    .card-title .icon{font-size:18px;}
    .card-subtitle{font-size:12px;color:var(--muted);}
    label{font-size:12px;color:#cbd5f5;margin-bottom:3px;display:block;}
    .field{margin-bottom:8px;}
    textarea,input,select{
      width:100%;padding:8px 9px;border-radius:12px;border:1px solid rgba(55,65,81,0.9);
      background:rgba(15,23,42,0.96);color:var(--text);font-size:13px;outline:none;
    }
    textarea{resize:vertical;min-height:70px;max-height:130px;}
    .hint{font-size:11px;color:var(--muted);margin-top:2px;}
    .btn{
      border-radius:999px;border:none;padding:8px 13px;font-size:12px;font-weight:600;
      text-transform:uppercase;letter-spacing:.04em;cursor:pointer;
      display:inline-flex;align-items:center;gap:6px;
    }
    .btn-primary{
      background:linear-gradient(120deg,#4f46e5,#6366f1,#22c55e);color:white;
    }
    .btn-ghost{
      background:transparent;color:var(--muted);border:1px solid rgba(75,85,99,0.9);
    }
    .btn[disabled]{opacity:.7;cursor:wait;}
    .status-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
    .status-pill{
      font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(75,85,99,0.9);
      display:inline-flex;gap:6px;align-items:center;
    }
    .status-pill.online{border-color:rgba(34,197,94,0.9);background:rgba(22,163,74,0.18);}
    .status-pill.offline{border-color:rgba(239,68,68,0.9);background:rgba(248,113,113,0.16);}
    .status-pill.maintenance{border-color:rgba(249,115,22,0.9);background:rgba(251,146,60,0.16);}
    .server-last-updated{font-size:11px;color:var(--muted);margin-top:4px;}
    .requests-wrapper{
      max-height:420px;overflow:auto;border-radius:14px;border:1px solid rgba(31,41,55,0.95);margin-top:4px;
    }
    .requests-table{width:100%;border-collapse:collapse;font-size:12px;}
    .requests-table th,.requests-table td{
      padding:6px 6px;border-bottom:1px solid rgba(31,41,55,0.95);vertical-align:top;
    }
    .requests-table th{
      text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);
      position:sticky;top:0;background:#020617;
    }
    .status-badge{
      display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:999px;
      border:1px solid rgba(55,65,81,0.9);font-size:11px;
    }
    .status-badge.hazirlaniyor{border-color:rgba(59,130,246,0.9);background:rgba(37,99,235,0.18);}
    .status-badge.gonderiliyor{border-color:rgba(129,140,248,0.9);background:rgba(129,140,248,0.17);}
    .status-badge.kontrolde{border-color:rgba(249,115,22,0.9);background:rgba(251,146,60,0.18);}
    .status-badge.tamamlandi{border-color:rgba(34,197,94,0.9);background:rgba(34,197,94,0.16);}
    .badge-platform{
      border-radius:999px;padding:2px 7px;border:1px solid rgba(75,85,99,0.9);
      display:inline-flex;gap:4px;align-items:center;
    }
    .link-cell a{color:#38bdf8;text-decoration:none;word-break:break-all;}
    .small{font-size:11px;color:var(--muted);}
    .users-wrapper{
      max-height:260px;overflow:auto;border-radius:14px;border:1px solid rgba(31,41,55,0.95);margin-top:4px;
    }
    .users-table{width:100%;border-collapse:collapse;font-size:12px;}
    .users-table th,.users-table td{
      padding:6px 6px;border-bottom:1px solid rgba(31,41,55,0.95);vertical-align:top;
    }
    .users-table th{
      text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);
      position:sticky;top:0;background:#020617;
    }
    .badge-role-user,.badge-role-vip,.badge-role-banned{
      padding:2px 7px;border-radius:999px;font-size:11px;
    }
    .badge-role-user{border:1px solid rgba(148,163,184,0.9);}
    .badge-role-vip{border:1px solid rgba(250,204,21,0.9);background:rgba(250,204,21,0.12);color:#facc15;}
    .badge-role-banned{border:1px solid rgba(239,68,68,0.9);background:rgba(239,68,68,0.12);color:#fecaca;}
    .error-text{font-size:12px;color:#fecaca;margin-top:6px;}
    .success-text{font-size:12px;color:#bbf7d0;margin-top:6px;}

    /* Filtre satƒ±rƒ± */
    .filter-row{
      margin-top:8px;margin-bottom:4px;
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;font-size:12px;
    }
    .filter-row select{
      flex:0 0 150px;
      padding:6px 8px;border-radius:12px;
      border:1px solid rgba(55,65,81,0.9);
      background:rgba(15,23,42,0.96);color:var(--text);font-size:12px;
    }

    /* MESAJLAR TABLOSU */
    .messages-wrapper{
      max-height:260px;overflow:auto;border-radius:14px;border:1px solid rgba(31,41,55,0.95);margin-top:4px;
    }
    .messages-table{width:100%;border-collapse:collapse;font-size:12px;}
    .messages-table th,.messages-table td{
      padding:6px 6px;border-bottom:1px solid rgba(31,41,55,0.95);vertical-align:top;
    }
    .messages-table th{
      text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);
      position:sticky;top:0;background:#020617;
    }
    .badge-msg-unread{
      padding:2px 7px;border-radius:999px;border:1px solid rgba(59,130,246,0.9);
      background:rgba(37,99,235,0.18);font-size:11px;color:#dbeafe;
    }
    .badge-msg-read{
      padding:2px 7px;border-radius:999px;border:1px solid rgba(148,163,184,0.9);
      background:rgba(15,23,42,0.9);font-size:11px;color:#e5e7eb;
    }

    /* ADMIN LOGIN OVERLAY */
    .admin-login-overlay{
      position:absolute;inset:0;
      background:radial-gradient(circle at top,rgba(15,23,42,0.96),rgba(15,23,42,0.99));
      backdrop-filter:blur(10px);
      display:flex;align-items:center;justify-content:center;z-index:100;
    }
    .admin-login-card{
      width:100%;max-width:400px;background:rgba(15,23,42,0.98);
      border-radius:24px;border:1px solid rgba(148,163,184,0.5);
      padding:18px 18px 16px;box-shadow:0 22px 40px rgba(15,23,42,0.9);
    }
    .admin-login-title{font-size:18px;font-weight:600;margin-bottom:4px;}
    .admin-login-sub{font-size:13px;color:var(--muted);}
    .admin-login-row{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;}
    .admin-login-row input{flex:1 1 160px;}
    .btn-admin-login{
      border-radius:999px;border:none;padding:8px 14px;font-size:13px;font-weight:600;
      letter-spacing:.04em;text-transform:uppercase;cursor:pointer;
      background:linear-gradient(120deg,#4f46e5,#6366f1);color:white;
    }
    .btn-admin-login[disabled]{opacity:.7;cursor:wait;}
    .admin-login-error{margin-top:6px;font-size:12px;color:#fecaca;}
    .admin-login-hint{margin-top:6px;font-size:11px;color:var(--muted);}
  </style>
</head>
<body>
  <div class="app">
    <!-- Admin login -->
    <div class="admin-login-overlay" id="adminLoginOverlay">
      <div class="admin-login-card">
        <div class="admin-login-title">üîê Admin Giri≈üi</div>
        <div class="admin-login-sub">Admin paneline eri≈ümek i√ßin ≈üifreyi gir.</div>
        <div class="admin-login-row">
          <input id="adminPassInput" type="password" placeholder="Admin ≈üifresi" />
          <button id="adminLoginBtn" class="btn-admin-login">Giri≈ü yap</button>
        </div>
        <div id="adminLoginError" class="admin-login-error" style="display:none;"></div>
        <div class="admin-login-hint">
          Bu dosyada ayarlƒ± ≈üifre: <strong>nrusplus</strong> (istersen koddan deƒüi≈ütirebilirsin).
        </div>
      </div>
    </div>

    <header class="app-header">
      <div class="brand">
        <div class="brand-logo"><span>SP</span></div>
        <div class="brand-text">
          <div class="brand-title">
            Servis Paneli <span class="brand-pill">Admin</span>
          </div>
          <div class="brand-subtitle">Talepleri, kullanƒ±cƒ±larƒ± ve mesajlarƒ± y√∂net.</div>
        </div>
      </div>
      <div class="header-right">
        <div class="badge-online"><span class="dot"></span> Panel aktif</div>
        <div class="admin-tag">Y√∂netici hesabƒ±</div>
      </div>
    </header>

    <div class="grid">
      <!-- Sistem Ayarlarƒ± -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="icon">üõ†Ô∏è</span> Sistem Ayarlarƒ±</div>
            <p class="card-subtitle">Sunucu durumu ve duyurularƒ± buradan g√ºncelleyebilirsin.</p>
          </div>
        </div>

        <div class="field">
          <label>Sunucu durumu</label>
          <select id="serverStatusSelect">
            <option value="online">Online</option>
            <option value="offline">Offline</option>
            <option value="maintenance">Bakƒ±m modunda</option>
          </select>
          <div class="hint">User tarafƒ±na direkt yansƒ±r.</div>
        </div>

        <div class="field">
          <label>Sunucu durum mesajƒ±</label>
          <textarea id="serverStatusMessage" placeholder="√ñrn: ≈ûu an t√ºm sistemler aktif."></textarea>
        </div>

        <div class="status-row">
          <div id="serverStatusPreview" class="status-pill online">
            <span class="dot"></span><span>Online</span>
          </div>
        </div>
        <div class="server-last-updated" id="serverLastUpdated">Son g√ºncelleme: -</div>

        <hr style="border-color:rgba(31,41,55,0.9);margin:10px 0;" />

        <div class="field">
          <label>Duyuru ba≈ülƒ±ƒüƒ±</label>
          <input id="announcementTitleInput" placeholder="√ñrn: Sistem Bakƒ±mƒ±" />
        </div>
        <div class="field">
          <label>Duyuru metni</label>
          <textarea id="announcementTextInput" placeholder="√ñrn: Bu ak≈üam 23:00 - 01:00 bakƒ±mdan dolayƒ± kapalƒ±."></textarea>
          <div class="hint">Bo≈ü bƒ±rakƒ±rsan user tarafƒ±nda duyuru kutusu √ßƒ±kmaz.</div>
        </div>

        <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;">
          <button class="btn btn-primary" id="saveSettingsBtn">üíæ Ayarlarƒ± Kaydet</button>
          <button class="btn btn-ghost" id="clearAnnouncementBtn">üßπ Duyuruyu Temizle</button>
        </div>

        <div id="settingsError" class="error-text" style="display:none;"></div>
        <div id="settingsSuccess" class="success-text" style="display:none;"></div>
      </section>

      <!-- Talepler -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><span class="icon">üìã</span> Kullanƒ±cƒ± Talepleri</div>
            <p class="card-subtitle">Durumlarƒ± deƒüi≈ütirerek s√ºreci y√∂netebilirsin.</p>
          </div>
        </div>

        <!-- Filtreler -->
        <div class="filter-row">
          <span>Filtre:</span>
          <select id="statusFilter">
            <option value="all">T√ºm durumlar</option>
            <option value="hazirlaniyor">Hazƒ±rlanƒ±yor</option>
            <option value="gonderiliyor">G√∂nderiliyor / ƒ∞≈üleniyor</option>
            <option value="kontrolde">Y√∂netici kontrol√ºnde</option>
            <option value="tamamlandi">Tamamlandƒ±</option>
          </select>
          <select id="platformFilter">
            <option value="all">T√ºm platformlar</option>
            <option value="TikTok">TikTok</option>
            <option value="Instagram">Instagram</option>
            <option value="YouTube">YouTube</option>
            <option value="X">X (Twitter)</option>
            <option value="Facebook">Facebook</option>
          </select>
        </div>

        <div class="requests-wrapper">
          <table class="requests-table">
            <thead>
              <tr>
                <th>Kullanƒ±cƒ±</th>
                <th>Talep</th>
                <th>Link & Not</th>
                <th>Durum / ƒ∞≈ülem</th>
              </tr>
            </thead>
            <tbody id="requestsTbody">
              <tr><td colspan="4" style="padding:10px;">Talepler y√ºkleniyor...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <!-- Kullanƒ±cƒ± Y√∂netimi -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title"><span class="icon">üë§</span> Kullanƒ±cƒ± Y√∂netimi</div>
          <p class="card-subtitle">ƒ∞simle giren kullanƒ±cƒ±lar burada listelenir. Rol atamasƒ± yapabilirsin.</p>
        </div>
      </div>
      <div class="users-wrapper">
        <table class="users-table">
          <thead>
            <tr>
              <th>Kullanƒ±cƒ±</th>
              <th>Rol</th>
              <th>Olu≈üturma</th>
              <th>ƒ∞≈ülem</th>
            </tr>
          </thead>
          <tbody id="usersTbody">
            <tr><td colspan="4" style="padding:10px;">Kullanƒ±cƒ±lar y√ºkleniyor...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- √ñzel Mesajlar -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title"><span class="icon">üí¨</span> √ñzel Mesajlar</div>
          <p class="card-subtitle">Kullanƒ±cƒ±larƒ±n admine g√∂nderdiƒüi mesajlarƒ± buradan okuyup y√∂netebilirsin.</p>
        </div>
      </div>

      <div class="messages-wrapper">
        <table class="messages-table">
          <thead>
            <tr>
              <th>Kullanƒ±cƒ±</th>
              <th>Konu & Mesaj</th>
              <th>Tarih / Durum</th>
              <th>ƒ∞≈ülem</th>
            </tr>
          </thead>
          <tbody id="messagesTbody">
            <tr><td colspan="4" style="padding:10px;">Mesajlar y√ºkleniyor...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore, collection, doc, updateDoc, onSnapshot, query,
      orderBy, getDoc, setDoc, serverTimestamp, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDWfmgssPwMkXRilR4qc4V8gJs2efzumuY",
      authDomain: "quality-3362.firebaseapp.com",
      projectId: "quality-3362",
      storageBucket: "quality-3362.firebasestorage.app",
      messagingSenderId: "367542295102",
      appId: "1:367542295102:web:5d482d7434193f1ef14f6f",
      measurementId: "G-3MBQW29YRD"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const requestsCol = collection(db,"requests");
    const usersCol = collection(db,"users");
    const settingsDocRef = doc(db,"config","settings");
    const adminMessagesCol = collection(db,"adminMessages");

    const serverStatusSelect=document.getElementById("serverStatusSelect");
    const serverStatusMessage=document.getElementById("serverStatusMessage");
    const serverStatusPreview=document.getElementById("serverStatusPreview");
    const serverLastUpdated=document.getElementById("serverLastUpdated");
    const announcementTitleInput=document.getElementById("announcementTitleInput");
    const announcementTextInput=document.getElementById("announcementTextInput");
    const saveSettingsBtn=document.getElementById("saveSettingsBtn");
    const clearAnnouncementBtn=document.getElementById("clearAnnouncementBtn");
    const settingsError=document.getElementById("settingsError");
    const settingsSuccess=document.getElementById("settingsSuccess");

    const requestsTbody=document.getElementById("requestsTbody");
    const usersTbody=document.getElementById("usersTbody");
    const messagesTbody=document.getElementById("messagesTbody");

    const statusFilterSelect=document.getElementById("statusFilter");
    const platformFilterSelect=document.getElementById("platformFilter");

    const adminLoginOverlay=document.getElementById("adminLoginOverlay");
    const adminPassInput=document.getElementById("adminPassInput");
    const adminLoginBtn=document.getElementById("adminLoginBtn");
    const adminLoginError=document.getElementById("adminLoginError");
    const ADMIN_PASSWORD="nrusplus";

    function two(n){return n<10?"0"+n:n;}

    // Admin login (her seferinde, localStorage yok)
    adminLoginBtn.addEventListener("click",()=>{
      adminLoginError.style.display="none";
      const val=adminPassInput.value.trim();
      if(!val){
        adminLoginError.textContent="L√ºtfen ≈üifre gir.";
        adminLoginError.style.display="block";
        return;
      }
      if(val===ADMIN_PASSWORD){
        adminLoginOverlay.style.display="none";
      }else{
        adminLoginError.textContent="≈ûifre hatalƒ±.";
        adminLoginError.style.display="block";
      }
    });
    adminPassInput.addEventListener("keyup",e=>{if(e.key==="Enter")adminLoginBtn.click();});

    // Sunucu √∂nizleme
    function updateServerPreview(){
      const v=serverStatusSelect.value;
      serverStatusPreview.classList.remove("online","offline","maintenance");
      let t="";
      if(v==="online"){serverStatusPreview.classList.add("online");t="Online";}
      else if(v==="offline"){serverStatusPreview.classList.add("offline");t="Offline";}
      else{serverStatusPreview.classList.add("maintenance");t="Bakƒ±m modunda";}
      serverStatusPreview.querySelector("span:last-child").textContent=t;
    }
    serverStatusSelect.addEventListener("change",updateServerPreview);
    updateServerPreview();

    // Ayarlarƒ± y√ºkle
    async function loadSettings(){
      try{
        const snap=await getDoc(settingsDocRef);
        if(!snap.exists())return;
        const data=snap.data();
        if(data.serverStatus){serverStatusSelect.value=data.serverStatus;updateServerPreview();}
        if(data.serverStatusMessage){serverStatusMessage.value=data.serverStatusMessage;}
        if(data.announcementTitle){announcementTitleInput.value=data.announcementTitle;}
        if(data.announcementText){announcementTextInput.value=data.announcementText;}
        if(data.updatedAt?.toDate){
          const dt=data.updatedAt.toDate();
          serverLastUpdated.textContent=`Son g√ºncelleme: ${two(dt.getDate())}.${two(dt.getMonth()+1)} ‚Ä¢ ${two(dt.getHours())}:${two(dt.getMinutes())}`;
        }
      }catch(err){console.error("Ayarlar y√ºklenemedi",err);}
    }
    loadSettings();

    // Ayar Kaydet
    saveSettingsBtn.addEventListener("click",async()=>{
      settingsError.style.display="none";settingsSuccess.style.display="none";
      const serverStatus=serverStatusSelect.value;
      const serverStatusMsg=serverStatusMessage.value.trim();
      const aTitle=announcementTitleInput.value.trim();
      const aText=announcementTextInput.value.trim();
      saveSettingsBtn.disabled=true;saveSettingsBtn.textContent="Kaydediliyor...";
      try{
        await setDoc(settingsDocRef,{
          serverStatus,
          serverStatusMessage:serverStatusMsg,
          announcementTitle:aTitle||null,
          announcementText:aText||null,
          updatedAt:serverTimestamp(),
          announcementUpdatedAt:serverTimestamp()
        },{merge:true});
        settingsSuccess.textContent="Ayarlar kaydedildi.";settingsSuccess.style.display="block";
        await loadSettings();
      }catch(err){
        console.error("Ayar kaydet hata:",err);
        settingsError.textContent="Ayarlar kaydedilirken hata: "+(err.message||"");
        settingsError.style.display="block";
      }finally{
        saveSettingsBtn.disabled=false;saveSettingsBtn.textContent="üíæ Ayarlarƒ± Kaydet";
      }
    });
    clearAnnouncementBtn.addEventListener("click",()=>{announcementTitleInput.value="";announcementTextInput.value="";});

    // Status yardƒ±mcƒ±larƒ±
    function statusBadgeClass(s){
      switch(s){
        case "hazirlaniyor":return"hazirlaniyor";
        case "gonderiliyor":
        case "isleniyor":return"gonderiliyor";
        case "kontrolde":return"kontrolde";
        case "tamamlandi":return"tamamlandi";
        default:return"";
      }
    }
    function statusText(s){
      switch(s){
        case "hazirlaniyor":return"Hazƒ±rlanƒ±yor";
        case "gonderiliyor":
        case "isleniyor":return"G√∂nderiliyor / ƒ∞≈üleniyor";
        case "kontrolde":return"Y√∂netici kontrol√ºnde";
        case "tamamlandi":return"Tamamlandƒ±";
        default:return"Bilinmiyor";
      }
    }

    // TALEPLER: cache + filtre
    let requestsCache = [];

    const qRequests=query(requestsCol,orderBy("createdAt","desc"));
    onSnapshot(qRequests,snapshot=>{
      requestsCache = [];
      snapshot.forEach(docSnap=>{
        requestsCache.push({ id: docSnap.id, data: docSnap.data() });
      });
      renderRequests();
    });

    statusFilterSelect.addEventListener("change",renderRequests);
    platformFilterSelect.addEventListener("change",renderRequests);

    function renderRequests(){
      if(!requestsCache.length){
        requestsTbody.innerHTML='<tr><td colspan="4" style="padding:10px;">Hen√ºz talep yok.</td></tr>';
        return;
      }
      const statusFilter = statusFilterSelect.value;
      const platformFilter = platformFilterSelect.value;

      let html = "";
      requestsCache.forEach(item=>{
        const d = item.data;
        const id = item.id;
        const st = d.status || "hazirlaniyor";
        const platform = d.platform || "";
        if(statusFilter !== "all"){
          if(statusFilter === "gonderiliyor"){
            if(!(st==="gonderiliyor" || st==="isleniyor")) return;
          }else if(st !== statusFilter) return;
        }
        if(platformFilter !== "all" && platform !== platformFilter) return;

        const createdAt=d.createdAt?.toDate?d.createdAt.toDate():null;
        let timeText="";
        if(createdAt){
          timeText=`${two(createdAt.getDate())}.${two(createdAt.getMonth()+1)} ‚Ä¢ ${two(createdAt.getHours())}:${two(createdAt.getMinutes())}`;
        }
        const role=d.userRole||"user";
        const roleLabel=role==="vip"
          ? '<span class="badge-role-vip">VIP</span>'
          : role==="banned"
            ? '<span class="badge-role-banned">BANNED</span>'
            : '<span class="badge-role-user">USER</span>';

        html+=`
          <tr data-id="${id}">
            <td>
              <strong>${d.userName||"Bilinmiyor"}</strong>
              <div class="small">${timeText||"-"}</div>
              <div class="small">Rol: ${roleLabel}</div>
            </td>
            <td>
              <div class="badge-platform">
                <span>${d.platform||"-"}</span>
                <span>‚Ä¢</span>
                <span>${d.serviceType||"-"}</span>
              </div>
              <div class="small">Adet: ${d.quantity||"-"}, √ñncelik: ${d.priority||"Normal"}</div>
            </td>
            <td class="link-cell">
              <a href="${d.link}" target="_blank" rel="noopener noreferrer">${d.link}</a>
              ${d.notes?`<div class="small" style="margin-top:3px;">Not: ${d.notes}</div>`:""}
            </td>
            <td>
              <div style="display:flex;flex-direction:column;gap:4px;">
                <span class="status-badge ${statusBadgeClass(st)}">${statusText(st)}</span>
                <select class="statusSelect">
                  <option value="hazirlaniyor" ${st==="hazirlaniyor"?"selected":""}>Hazƒ±rlanƒ±yor</option>
                  <option value="gonderiliyor" ${st==="gonderiliyor"||st==="isleniyor"?"selected":""}>G√∂nderiliyor / ƒ∞≈üleniyor</option>
                  <option value="kontrolde" ${st==="kontrolde"?"selected":""}>Y√∂netici kontrol√ºnde</option>
                  <option value="tamamlandi" ${st==="tamamlandi"?"selected":""}>Tamamlandƒ±</option>
                </select>
                <button class="btn btn-ghost btnUpdateStatus">G√ºncelle</button>
                ${st==="hazirlaniyor"
                  ? '<button class="btn btn-primary btnTakeInProcess">ƒ∞≈üleme al</button>'
                  : ''
                }
                <button class="btn btn-ghost btnDeleteRequest" style="border-color:rgba(248,113,113,0.8);color:#fecaca;">
                  Sil
                </button>
              </div>
            </td>
          </tr>
        `;
      });

      if(!html){
        requestsTbody.innerHTML='<tr><td colspan="4" style="padding:10px;">Filtreye uygun talep yok.</td></tr>';
      }else{
        requestsTbody.innerHTML = html;
        attachStatusEvents();
      }
    }

    function attachStatusEvents(){
      const rows = document.querySelectorAll("#requestsTbody tr");
      rows.forEach((tr)=>{
        const id = tr.dataset.id;
        if(!id) return;

        const btnUpdate = tr.querySelector(".btnUpdateStatus");
        const statusSelect = tr.querySelector(".statusSelect");
        const btnTake = tr.querySelector(".btnTakeInProcess");
        const btnDelete = tr.querySelector(".btnDeleteRequest");

        // Normal "G√ºncelle"
        if (btnUpdate && statusSelect) {
          btnUpdate.onclick = async () => {
            const newStatus = statusSelect.value;
            btnUpdate.disabled = true;
            btnUpdate.textContent = "Kaydediliyor...";
            try{
              await updateDoc(doc(db,"requests",id),{status:newStatus});
            }catch(err){
              console.error("Durum g√ºncelleme hata:",err);
              alert("Durum g√ºncellenirken hata olu≈ütu.");
            }finally{
              btnUpdate.disabled = false;
              btnUpdate.textContent = "G√ºncelle";
            }
          };
        }

        // "ƒ∞≈üleme al" ‚Üí hazirlaniyor ‚Üí gonderiliyor
        if (btnTake) {
          btnTake.onclick = async () => {
            btnTake.disabled = true;
            btnTake.textContent = "ƒ∞≈üleme alƒ±nƒ±yor...";
            try{
              await updateDoc(doc(db,"requests",id),{status:"gonderiliyor"});
            }catch(err){
              console.error("ƒ∞≈üleme al hata:",err);
              alert("Talep i≈üleme alƒ±nƒ±rken hata olu≈ütu.");
            }finally{
              btnTake.disabled = false;
              btnTake.textContent = "ƒ∞≈üleme al";
            }
          };
        }

        // Silme
        if (btnDelete) {
          btnDelete.onclick = async () => {
            const ok = confirm("Bu talebi kalƒ±cƒ± olarak silmek istiyor musun?");
            if(!ok) return;
            btnDelete.disabled = true;
            btnDelete.textContent = "Siliniyor...";
            try{
              await deleteDoc(doc(db,"requests",id));
            }catch(err){
              console.error("Talep silme hata:",err);
              alert("Talep silinirken hata olu≈ütu.");
              btnDelete.disabled = false;
              btnDelete.textContent = "Sil";
            }
          };
        }
      });
    }

    // Kullanƒ±cƒ±lar dinle
    const qUsers=query(usersCol,orderBy("createdAt","desc"));
    onSnapshot(qUsers,snapshot=>{
      if(snapshot.empty){
        usersTbody.innerHTML='<tr><td colspan="4" style="padding:10px;">Hen√ºz kullanƒ±cƒ± yok.</td></tr>';
        return;
      }
      let html="";
      snapshot.forEach(docSnap=>{
        const d=docSnap.data();
        const id=docSnap.id;
        const createdAt=d.createdAt?.toDate?d.createdAt.toDate():null;
        let timeText="";
        if(createdAt){
          timeText=`${two(createdAt.getDate())}.${two(createdAt.getMonth()+1)} ‚Ä¢ ${two(createdAt.getHours())}:${two(createdAt.getMinutes())}`;
        }
        const role=d.role||"user";
        let badgeClass="badge-role-user";
        if(role==="vip")badgeClass="badge-role-vip";
        if(role==="banned")badgeClass="badge-role-banned";

        html+=`
          <tr data-id="${id}">
            <td>
              <strong>${d.name||"ƒ∞simsiz"}</strong>
              <div class="small">${id}</div>
            </td>
            <td><span class="${badgeClass}">${role.toUpperCase()}</span></td>
            <td><div class="small">${timeText||"-"}</div></td>
            <td>
              <div style="display:flex;flex-direction:column;gap:4px;">
                <select class="roleSelect">
                  <option value="user" ${role==="user"?"selected":""}>User</option>
                  <option value="vip" ${role==="vip"?"selected":""}>VIP</option>
                  <option value="banned" ${role==="banned"?"selected":""}>Banned</option>
                </select>
                <button class="btn btn-ghost btnUpdateRole">Rol√º Kaydet</button>
              </div>
            </td>
          </tr>
        `;
      });
      usersTbody.innerHTML=html;
      attachRoleEvents();
    });

    function attachRoleEvents(){
      document.querySelectorAll(".btnUpdateRole").forEach(btn=>{
        btn.onclick=async e=>{
          const tr=e.target.closest("tr");
          const id=tr.dataset.id;
          const select=tr.querySelector(".roleSelect");
          const newRole=select.value;
          btn.disabled=true;btn.textContent="Kaydediliyor...";
          try{
            await updateDoc(doc(db,"users",id),{role:newRole});
          }catch(err){
            console.error("Rol g√ºncelleme hata:",err);
            alert("Rol g√ºncellenirken hata olu≈ütu.");
          }finally{
            btn.disabled=false;btn.textContent="Rol√º Kaydet";
          }
        };
      });
    }

    // √ñzel Mesajlar dinle
    const qMessages = query(adminMessagesCol, orderBy("createdAt","desc"));
    onSnapshot(qMessages, snapshot => {
      if (snapshot.empty) {
        messagesTbody.innerHTML = '<tr><td colspan="4" style="padding:10px;">Hen√ºz mesaj yok.</td></tr>';
        return;
      }
      let html = "";
      snapshot.forEach(docSnap => {
        const d = docSnap.data();
        const id = docSnap.id;
        const createdAt = d.createdAt?.toDate ? d.createdAt.toDate() : null;
        let timeText = "";
        if (createdAt) {
          timeText = `${two(createdAt.getDate())}.${two(createdAt.getMonth()+1)} ‚Ä¢ ${two(createdAt.getHours())}:${two(createdAt.getMinutes())}`;
        }
        const status = d.status || "unread";
        const statusBadge = status === "unread"
          ? '<span class="badge-msg-unread">Okunmadƒ±</span>'
          : '<span class="badge-msg-read">Okundu</span>';

        html += `
          <tr data-id="${id}">
            <td>
              <strong>${d.userName || "Bilinmiyor"}</strong>
              <div class="small">${d.userId || "-"}</div>
            </td>
            <td>
              <strong>${d.subject || "Konu yok"}</strong>
              <div class="small" style="margin-top:3px;">${(d.message || "").replace(/\n/g,"<br>")}</div>
            </td>
            <td>
              <div class="small">${timeText || "-"}</div>
              <div style="margin-top:4px;">${statusBadge}</div>
            </td>
            <td>
              <div style="display:flex;flex-direction:column;gap:4px;">
                <button class="btn btn-ghost btnToggleMsgStatus">
                  ${status === "unread" ? "Okundu olarak i≈üaretle" : "Tekrar okunmadƒ± yap"}
                </button>
                <button class="btn btn-ghost btnDeleteMsg" style="border-color:rgba(248,113,113,0.8);color:#fecaca;">
                  Mesajƒ± Sil
                </button>
              </div>
            </td>
          </tr>
        `;
      });
      messagesTbody.innerHTML = html;
      attachMessageEvents();
    });

    function attachMessageEvents(){
      document.querySelectorAll("#messagesTbody tr").forEach(tr=>{
        const id = tr.dataset.id;
        if(!id) return;
        const btnToggle = tr.querySelector(".btnToggleMsgStatus");
        const btnDelete = tr.querySelector(".btnDeleteMsg");

        if (btnToggle) {
          btnToggle.onclick = async () => {
            // mevcut badge'e bakarak karar verelim
            const badgeUnread = tr.querySelector(".badge-msg-unread");
            const newStatus = badgeUnread ? "read" : "unread";
            btnToggle.disabled = true;
            btnToggle.textContent = "G√ºncelleniyor...";
            try{
              await updateDoc(doc(db,"adminMessages",id),{status:newStatus});
            }catch(err){
              console.error("Mesaj durum g√ºncelleme hata:",err);
              alert("Mesaj durumu g√ºncellenemedi.");
            }finally{
              btnToggle.disabled = false;
            }
          };
        }

        if (btnDelete) {
          btnDelete.onclick = async () => {
            const ok = confirm("Bu mesajƒ± kalƒ±cƒ± olarak silmek istiyor musun?");
            if(!ok) return;
            btnDelete.disabled = true;
            btnDelete.textContent = "Siliniyor...";
            try{
              await deleteDoc(doc(db,"adminMessages",id));
            }catch(err){
              console.error("Mesaj silme hata:",err);
              alert("Mesaj silinirken hata olu≈ütu.");
              btnDelete.disabled = false;
              btnDelete.textContent = "Mesajƒ± Sil";
            }
          };
        }
      });
    }
  </script>
</body>
</html>
