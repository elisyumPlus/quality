<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Servis Paneli - Kullanƒ±cƒ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg: #070b18;
      --bg-soft: #0d1224;
      --bg-softer: #151b30;
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.1);
      --accent-2: #22c55e;
      --text: #f9fafb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --border: #1f2937;
      --rounded-lg: 16px;
      --rounded-xl: 24px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.65);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 45%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    .app {
      width: 100%;
      max-width: 1120px;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.92));
      border-radius: 32px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: var(--shadow-soft);
      padding: 24px 22px 26px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      position: relative;
      overflow: hidden;
    }

    .app::before {
      content: "";
      position: absolute;
      inset: -200px;
      background:
        radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.06), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(129, 140, 248, 0.08), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
      z-index: -1;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 10px 12px 6px;
      border-radius: 20px;
      background: radial-gradient(circle at top left, rgba(79, 70, 229, 0.18), transparent 60%),
                  rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(99, 102, 241, 0.35);
      position: relative;
      overflow: hidden;
    }

    .app-header::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, rgba(255, 255, 255, 0.07), transparent 60%);
      mix-blend-mode: screen;
      opacity: 0.8;
      pointer-events: none;
    }

    .brand { display: flex; align-items: center; gap: 12px; position: relative; z-index: 1; }
    .brand-logo {
      width: 38px; height: 38px; border-radius: 14px;
      background: conic-gradient(from 200deg, #4f46e5, #22c55e, #ec4899, #4f46e5);
      display: inline-flex; align-items: center; justify-content: center;
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.4), 0 10px 25px rgba(15, 23, 42, 0.9);
      position: relative;
    }
    .brand-logo span { font-weight: 700; font-size: 17px; color: #f9fafb; }
    .brand-text { display: flex; flex-direction: column; gap: 2px; }
    .brand-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
    .brand-pill {
      font-size: 11px; padding: 2px 7px; border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6); text-transform: uppercase;
    }
    .brand-subtitle { font-size: 12px; color: var(--muted); }

    .header-right { display: flex; align-items: center; gap: 12px; position: relative; z-index: 1; }

    .time-box {
      padding: 6px 10px; border-radius: 999px;
      background: rgba(15, 23, 42, 0.88);
      border: 1px solid rgba(148, 163, 184, 0.55);
      font-size: 11px;
      display: flex; align-items: center; gap: 8px;
    }
    .time-dot { width: 8px; height: 8px; border-radius: 999px; background: #22c55e; }

    .user-pill {
      font-size: 12px; padding: 7px 12px; border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.7);
      display: flex; align-items: center; gap: 6px;
    }
    .user-avatar {
      width: 22px; height: 22px; border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #f97316, #4f46e5);
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 600;
    }
    .vip-pill {
      font-size: 10px; padding: 2px 6px; border-radius: 999px;
      border: 1px solid rgba(251, 191, 36, 0.8);
      background: rgba(250, 204, 21, 0.15);
      color: #facc15; text-transform: uppercase; letter-spacing: 0.06em;
    }

    .announcement {
      border-radius: var(--rounded-lg);
      padding: 10px 12px;
      background: linear-gradient(90deg, rgba(56, 189, 248, 0.18), rgba(129, 140, 248, 0.2));
      border: 1px solid rgba(56, 189, 248, 0.6);
      display: flex; align-items: flex-start; gap: 10px;
      font-size: 13px;
    }

    .announcement-icon { margin-top: 2px; font-size: 16px; }
    .announcement small { display: block; color: rgba(226, 232, 240, 0.8); margin-top: 2px; }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.1fr);
      gap: 18px; margin-top: 4px;
    }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card {
      border-radius: var(--rounded-xl);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.9), #020617);
      border: 1px solid rgba(31, 41, 55, 0.8);
      padding: 14px 14px 16px;
    }

    .card-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 14px; font-weight: 600;
      letter-spacing: 0.03em; text-transform: uppercase;
      display: flex; align-items: center; gap: 8px;
    }
    .card-title span.icon { font-size: 16px; }
    .card-subtitle { font-size: 12px; color: var(--muted); }

    .greeting { margin-top: 6px; font-size: 20px; font-weight: 600; }
    .greeting-sub { margin-top: 4px; font-size: 13px; color: var(--muted); }

    .small-label {
      font-size: 10px; text-transform: uppercase;
      letter-spacing: 0.08em; color: rgba(148, 163, 184, 0.9);
      margin-bottom: 3px;
    }
    .badge-role-info { font-size: 11px; color: var(--muted); }

    form { margin-top: 8px; display: flex; flex-direction: column; gap: 10px; font-size: 13px; }

    label { font-size: 12px; color: #cbd5f5; margin-bottom: 2px; display: block; }

    .field-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .field { flex: 1 1 140px; }

    select, input, textarea {
      width: 100%; padding: 8px 9px; border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text); font-size: 13px; outline: none;
    }
    select:focus, input:focus, textarea:focus {
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
    }

    textarea { resize: vertical; min-height: 70px; max-height: 130px; }

    .hint { font-size: 11px; color: var(--muted); margin-top: 2px; }

    .btn-primary {
      margin-top: 3px; border: none; border-radius: 999px;
      padding: 9px 14px; font-size: 13px; font-weight: 600;
      letter-spacing: 0.04em; text-transform: uppercase;
      background: radial-gradient(circle at 0 0, rgba(250, 250, 250, 0.15), transparent 58%),
                  linear-gradient(120deg, #4f46e5, #6366f1, #22c55e);
      color: white; cursor: pointer;
      box-shadow: 0 14px 30px rgba(79, 70, 229, 0.5);
      display: inline-flex; align-items: center; gap: 8px;
    }
    .btn-primary[disabled] { opacity: 0.65; cursor: wait; box-shadow: none; }

    .error-text { font-size: 12px; color: #fecaca; margin-top: 4px; }
    .success-text { font-size: 12px; color: #bbf7d0; margin-top: 4px; }

    .server-metrics {
      margin-top: 8px; display: flex; gap: 10px; flex-wrap: wrap; font-size: 11px;
    }
    .metric {
      padding: 6px 9px; border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(75, 85, 99, 0.9);
    }

    .status-pill {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 12px; padding: 5px 9px; border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(34, 197, 94, 0.6);
    }
    .status-pill.offline {
      border-color: rgba(239, 68, 68, 0.65);
      color: #fecaca;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 999px; background: #22c55e; }

    .requests { margin-top: 4px; max-height: 330px; overflow: auto; padding-right: 4px; }
    .request-empty { font-size: 12px; color: var(--muted); padding: 12px 0 4px; }

    .request-item {
      border-radius: 18px;
      border: 1px solid rgba(31, 41, 55, 0.95);
      background: linear-gradient(130deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.98));
      padding: 9px 10px 9px;
      margin-bottom: 7px;
      display: grid;
      grid-template-columns: 1.2fr 1.4fr auto;
      column-gap: 10px;
      row-gap: 4px;
      font-size: 12px;
    }
    @media (max-width: 780px) { .request-item { grid-template-columns: 1fr; } }

    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 3px 8px; border-radius: 999px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }
    .badge-status-hazirlaniyor {
      border-color: rgba(59, 130, 246, 0.9);
      background: rgba(37, 99, 235, 0.18);
      color: #dbeafe;
    }
    .badge-status-gonderiliyor {
      border-color: rgba(129, 140, 248, 0.9);
      background: rgba(129, 140, 248, 0.17);
      color: #e0e7ff;
    }
    .badge-status-kontrol {
      border-color: rgba(249, 115, 22, 0.9);
      background: rgba(251, 146, 60, 0.18);
      color: #ffedd5;
    }
    .badge-status-tamamlandi {
      border-color: rgba(34, 197, 94, 0.9);
      background: rgba(34, 197, 94, 0.16);
      color: #bbf7d0;
    }
    .badge-platform { border-color: rgba(148, 163, 184, 0.9); }

    .request-meta { display: flex; flex-wrap: wrap; gap: 4px; }
    .request-notes { margin-top: 4px; font-size: 12px; }
    .request-link a { color: #38bdf8; text-decoration: none; word-break: break-all; font-size: 11px; }
    .request-time { font-size: 11px; color: var(--muted); text-align: right; }

    /* LOGIN OVERLAY */
    .login-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.99));
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .login-card {
      width: 100%; max-width: 420px;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 18px 18px 16px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.85);
    }
    .login-title { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    .login-sub { font-size: 13px; color: var(--muted); }
    .login-row { margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
    .login-row input { flex: 1 1 160px; }
    .btn-login {
      border-radius: 999px; border: none; padding: 8px 14px;
      font-size: 13px; font-weight: 600; letter-spacing: 0.04em;
      text-transform: uppercase; cursor: pointer;
      background: linear-gradient(120deg, #4f46e5, #6366f1);
      color: white;
    }
    .btn-login[disabled] { opacity: 0.65; cursor: wait; }
    .login-error { margin-top: 6px; font-size: 12px; color: #fecaca; }
    .login-hint { margin-top: 6px; font-size: 11px; color: var(--muted); }
  </style>
</head>
<body>
  <div class="app">
    <!-- Gƒ∞Rƒ∞≈û OVERLAY -->
    <div class="login-overlay" id="loginOverlay">
      <div class="login-card">
        <div class="login-title">üîê Kullanƒ±cƒ± giri≈üi</div>
        <div class="login-sub">
          Sisteme giri≈ü i√ßin sadece ismini yazman yeterli. Aynƒ± isimle tekrar girersen, Firestore‚Äôdaki hesabƒ±n kullanƒ±lƒ±r.
        </div>

        <div class="login-row">
          <input id="loginNameInput" placeholder="√ñrn: Ahmet" />
          <button id="loginBtn" class="btn-login">Giri≈ü yap</button>
        </div>

        <div id="loginError" class="login-error" style="display:none;"></div>
        <div class="login-hint">
          VIP veya yasaklƒ± durumu admin tarafƒ±ndan belirlenir.
        </div>
      </div>
    </div>

    <!-- HEADER -->
    <header class="app-header">
      <div class="brand">
        <div class="brand-logo"><span>SP</span></div>
        <div class="brand-text">
          <div class="brand-title">
            Servis Paneli <span class="brand-pill">User</span>
          </div>
          <div class="brand-subtitle">Sosyal medya servis talebi, anlƒ±k durum takibi.</div>
        </div>
      </div>

      <div class="header-right">
        <div class="time-box">
          <div class="time-dot"></div>
          <span id="clockText">--:--</span>
        </div>
        <div class="user-pill">
          <div class="user-avatar" id="userAvatar">M</div>
          <span id="userNameLabel">Misafir</span>
          <span id="vipBadge" class="vip-pill" style="display:none;">VIP</span>
        </div>
      </div>
    </header>

    <!-- DUYURU -->
    <section class="announcement" id="announcementBox" style="display:none;">
      <div class="announcement-icon">üì¢</div>
      <div>
        <strong id="announcementTitle">Duyuru</strong>
        <div id="announcementText">≈ûu an i√ßin bir duyuru bulunmamaktadƒ±r.</div>
        <small id="announcementUpdated"></small>
      </div>
    </section>

    <div class="grid">
      <!-- SOL: KAR≈ûILAMA + FORM -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="icon">üëã</span> Kar≈üƒ±lama
            </div>
            <p class="card-subtitle">G√ºn√ºn saatine g√∂re dinamik mesaj.</p>
          </div>
          <span id="roleInfo" class="badge-role-info"></span>
        </div>

        <div class="greeting" id="greetingText">Merhaba!</div>
        <div class="greeting-sub" id="greetingSubText">
          Taleplerini detaylƒ± doldur, biz de s√ºreci ≈üeffaf ≈üekilde takip edelim.
        </div>

        <form id="requestForm">
          <div class="field-row">
            <div class="field">
              <label for="platform">Platform</label>
              <select id="platform" required>
                <option value="TikTok">TikTok</option>
                <option value="Instagram">Instagram</option>
                <option value="YouTube">YouTube</option>
                <option value="X">X (Twitter)</option>
                <option value="Facebook">Facebook</option>
              </select>
              <div class="hint">Talep hangi platform i√ßin?</div>
            </div>

            <div class="field">
              <label for="serviceType">Talep t√ºr√º</label>
              <select id="serviceType" required>
                <option value="Beƒüeni">Beƒüeni</option>
                <option value="ƒ∞zlenme">ƒ∞zlenme</option>
                <option value="Takip√ßi">Takip√ßi</option>
                <option value="Yorum">Yorum</option>
                <option value="Kaydetme">Kaydetme</option>
              </select>
              <div class="hint">ƒ∞stediƒüin servis t√ºr√º.</div>
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="quantity">Adet / Hedef</label>
              <input type="number" id="quantity" min="10" step="10" placeholder="√ñrn: 1000" required />
              <div class="hint">Tahmini adet (√∂rn. 1000 beƒüeni).</div>
            </div>

            <div class="field">
              <label for="priority">√ñncelik</label>
              <select id="priority">
                <option value="Normal">Normal</option>
                <option value="Y√ºksek">Y√ºksek</option>
              </select>
              <div class="hint">VIP kullanƒ±cƒ±lar i√ßin yoƒüunluk durumunda √∂ncelik verilebilir.</div>
            </div>
          </div>

          <div class="field">
            <label for="link">ƒ∞√ßerik linki</label>
            <input type="url" id="link" placeholder="https:// ..." required />
            <div class="hint">ƒ∞≈ülem yapƒ±lacak g√∂nderi / profil linki.</div>
          </div>

          <div class="field">
            <label for="notes">Not (opsiyonel)</label>
            <textarea id="notes" placeholder="√ñrn: Sadece son videoya izlenme gelsin."></textarea>
          </div>

          <div class="error-text" id="formError" style="display:none;"></div>

          <button class="btn-primary" type="submit" id="submitBtn">
            <span class="icon">üöÄ</span> Talebi G√∂nder
          </button>
        </form>
      </section>

      <!-- SAƒû: SUNUCU DURUMU + TALEPLER -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">
              <span class="icon">üõ∞Ô∏è</span> Sunucu & Talepler
            </div>
            <p class="card-subtitle">Anlƒ±k durum ve g√∂nderilen talepler.</p>
          </div>
          <div id="serverStatusPill" class="status-pill">
            <span class="status-dot"></span>
            <span id="serverStatusText">Durum y√ºkleniyor...</span>
          </div>
        </div>

        <div class="server-metrics">
          <div class="metric" id="metricQueue">Bekleyen talep: -</div>
          <div class="metric" id="metricInProgress">ƒ∞≈üleniyor: -</div>
          <div class="metric" id="metricCompleted">Tamamlandƒ±: -</div>
        </div>

        <div class="small-label" style="margin-top:10px;">Son talepler</div>
        <div class="requests" id="requestsContainer">
          <div class="request-empty">Hen√ºz bir talep olu≈üturulmadƒ±.</div>
        </div>
      </section>
    </div>

    <!-- ADMƒ∞NE √ñZEL MESAJ KARTI -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">
            <span class="icon">üí¨</span> Admƒ∞ne √ñzel Mesaj
          </div>
          <p class="card-subtitle">
            √ñneri, ≈üikayet veya √∂zel notlarƒ±nƒ± buradan admine iletebilirsin.
          </p>
        </div>
      </div>

      <form id="adminMessageForm">
        <div class="field">
          <label for="msgSubject">Konu</label>
          <input id="msgSubject" placeholder="√ñrn: Sistem hakkƒ±nda √∂neri" />
        </div>
        <div class="field">
          <label for="msgBody">Mesaj</label>
          <textarea id="msgBody" placeholder="Mesajƒ±nƒ± buraya yaz..."></textarea>
          <div class="hint">Bu mesaj sadece admin panelinde g√∂r√ºn√ºr, talepler listesinde g√∂r√ºnmez.</div>
        </div>

        <div id="msgError" class="error-text" style="display:none;"></div>
        <div id="msgSuccess" class="success-text" style="display:none;">Mesajƒ±n g√∂nderildi.</div>

        <button type="submit" class="btn-primary" id="msgSendBtn">
          üì© Mesajƒ± G√∂nder
        </button>
      </form>
    </section>
  </div>

  <script type="module">
    // Saat & selamlama
    const clockText = document.getElementById("clockText");
    const greetingText = document.getElementById("greetingText");
    const greetingSubText = document.getElementById("greetingSubText");
    function two(n){return n<10?"0"+n:n;}
    function updateClock(){
      const now=new Date();
      const h=now.getHours(), m=now.getMinutes();
      clockText.textContent=`${two(h)}:${two(m)}`;
      let main="Merhaba!", sub="Taleplerini detaylƒ± doldur, biz de s√ºreci ≈üeffaf ≈üekilde takip edelim.";
      if(h>=5&&h<12){main="G√ºnaydƒ±n ‚òÄÔ∏è";sub="Sabah erken saatler, i≈ülemler genelde daha hƒ±zlƒ± tamamlanƒ±r.";}
      else if(h>=12&&h<18){main="ƒ∞yi g√ºnler üå§Ô∏è";sub="√ñƒülen trafiƒüi yoƒüun olabilir ama talepler sƒ±rayla i≈ülenir.";}
      else if(h>=18&&h<23){main="ƒ∞yi ak≈üamlar üåô";sub="Ak≈üam talepleri genelde yoƒüunluk durumuna g√∂re i≈ülenir.";}
      else{main="Gece modu üåå";sub="Gece g√∂nderilen talepler bir sonraki mesai ba≈ülangƒ±cƒ±nda √∂ncelikli i≈ülenebilir.";}
      greetingText.textContent=main; greetingSubText.textContent=sub;
    }
    setInterval(updateClock,1000); updateClock();

    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      onSnapshot, query, orderBy, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDWfmgssPwMkXRilR4qc4V8gJs2efzumuY",
      authDomain: "quality-3362.firebaseapp.com",
      projectId: "quality-3362",
      storageBucket: "quality-3362.firebasestorage.app",
      messagingSenderId: "367542295102",
      appId: "1:367542295102:web:5d482d7434193f1ef14f6f",
      measurementId: "G-3MBQW29YRD"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const requestsCol = collection(db,"requests");
    const settingsDocRef = doc(db,"config","settings");
    const adminMessagesCol = collection(db,"adminMessages");

    // Kullanƒ±cƒ± state (sadece RAM'de)
    let currentUser = { id:null, name:"Misafir", role:"user" };
    const userNameLabel=document.getElementById("userNameLabel");
    const userAvatar=document.getElementById("userAvatar");
    const vipBadge=document.getElementById("vipBadge");
    const roleInfo=document.getElementById("roleInfo");

    function applyUserToUI(){
      userNameLabel.textContent=currentUser.name||"Misafir";
      userAvatar.textContent=(currentUser.name?.[0]||"M").toUpperCase();
      if(currentUser.role==="vip"){
        vipBadge.style.display="inline-flex";
        roleInfo.textContent="Rol√ºn: VIP kullanƒ±cƒ±";
      }else if(currentUser.role==="banned"){
        vipBadge.style.display="none";
        roleInfo.textContent="Rol√ºn: Yasaklƒ± / i≈ülem yapamaz";
      }else{
        vipBadge.style.display="none";
        roleInfo.textContent="Rol√ºn: Standart kullanƒ±cƒ±";
      }
      const form=document.getElementById("requestForm");
      const formError=document.getElementById("formError");
      if(currentUser.role==="banned"){
        form.querySelectorAll("input,select,textarea,button[type='submit']")
          .forEach(el=>el.disabled=true);
        formError.textContent="Hesabƒ±n y√∂netici tarafƒ±ndan yasaklanmƒ±≈ü. ƒ∞≈ülem yapamazsƒ±n.";
        formError.style.display="block";
      }else{
        form.querySelectorAll("input,select,textarea,button[type='submit']")
          .forEach(el=>el.disabled=false);
      }
    }

    function slugifyName(name){
      return name.trim().toLowerCase().replace(/\s+/g,"_");
    }

    // Login overlay
    const loginOverlay=document.getElementById("loginOverlay");
    const loginNameInput=document.getElementById("loginNameInput");
    const loginBtn=document.getElementById("loginBtn");
    const loginError=document.getElementById("loginError");

    async function handleLogin(name){
      const trimmed=name.trim();
      if(!trimmed) throw new Error("L√ºtfen ge√ßerli bir isim gir.");
      const userId=slugifyName(trimmed);
      const userDocRef=doc(db,"users",userId);
      const snap=await getDoc(userDocRef);
      if(!snap.exists()){
        await setDoc(userDocRef,{name:trimmed,role:"user",createdAt:serverTimestamp()});
        currentUser={id:userId,name:trimmed,role:"user"};
      }else{
        const data=snap.data();
        currentUser={
          id:userId,
          name:data.name||trimmed,
          role:data.role||"user"
        };
      }
      applyUserToUI();
    }

    loginBtn.addEventListener("click", async ()=>{
      loginError.style.display="none";
      const name=loginNameInput.value;
      if(!name.trim()){
        loginError.textContent="L√ºtfen bir isim gir.";
        loginError.style.display="block";
        return;
      }
      loginBtn.disabled=true;
      loginBtn.textContent="Kontrol ediliyor...";
      try{
        await handleLogin(name);
        loginOverlay.style.display="none";
      }catch(err){
        console.error(err);
        loginError.textContent=err.message||"Giri≈ü sƒ±rasƒ±nda bir hata olu≈ütu.";
        loginError.style.display="block";
      }finally{
        loginBtn.disabled=false;
        loginBtn.textContent="Giri≈ü yap";
      }
    });
    loginNameInput.addEventListener("keyup",e=>{if(e.key==="Enter")loginBtn.click();});

    // Form g√∂nderme
    const requestForm=document.getElementById("requestForm");
    const formError=document.getElementById("formError");
    const submitBtn=document.getElementById("submitBtn");

    requestForm.addEventListener("submit",async e=>{
      e.preventDefault();
      formError.style.display="none";
      if(!currentUser.id){
        formError.textContent="√ñnce kullanƒ±cƒ± giri≈üi yapmalƒ±sƒ±n.";
        formError.style.display="block";
        loginOverlay.style.display="flex";
        return;
      }
      if(currentUser.role==="banned"){
        formError.textContent="Hesabƒ±n yasaklƒ± olduƒüu i√ßin i≈ülem yapamazsƒ±n.";
        formError.style.display="block";
        return;
      }
      const platform=document.getElementById("platform").value;
      const serviceType=document.getElementById("serviceType").value;
      const quantity=document.getElementById("quantity").value;
      const priority=document.getElementById("priority").value;
      const link=document.getElementById("link").value.trim();
      const notes=document.getElementById("notes").value.trim();

      if(!link||!platform||!serviceType||!quantity){
        formError.textContent="L√ºtfen zorunlu alanlarƒ± doldurun.";
        formError.style.display="block";
        return;
      }

      submitBtn.disabled=true;
      submitBtn.textContent="G√∂nderiliyor...";

      try{
        await addDoc(requestsCol,{
          userId:currentUser.id,
          userName:currentUser.name,
          userRole:currentUser.role,
          platform,
          serviceType,
          quantity:Number(quantity),
          priority,
          link,
          notes,
          status:"hazirlaniyor",
          createdAt:serverTimestamp()
        });
        requestForm.reset();
      }catch(err){
        console.error(err);
        formError.textContent="Bir hata olu≈ütu. L√ºtfen tekrar deneyin.";
        formError.style.display="block";
      }finally{
        submitBtn.disabled=false;
        submitBtn.innerHTML="<span class='icon'>üöÄ</span> Talebi G√∂nder";
      }
    });

    // Talepleri listele
    const requestsContainer=document.getElementById("requestsContainer");
    const metricQueue=document.getElementById("metricQueue");
    const metricInProgress=document.getElementById("metricInProgress");
    const metricCompleted=document.getElementById("metricCompleted");

    const qRequests=query(requestsCol,orderBy("createdAt","desc"));

    onSnapshot(qRequests,snapshot=>{
      if(snapshot.empty){
        requestsContainer.innerHTML='<div class="request-empty">Hen√ºz bir talep yok.</div>';
        metricQueue.textContent="Bekleyen talep: 0";
        metricInProgress.textContent="ƒ∞≈üleniyor: 0";
        metricCompleted.textContent="Tamamlandƒ±: 0";
        return;
      }
      let html=""; let cQ=0,cP=0,cD=0;
      snapshot.forEach(docSnap=>{
        const d=docSnap.data();
        const st=d.status||"hazirlaniyor";
        if(st==="hazirlaniyor")cQ++;
        else if(st==="gonderiliyor"||st==="isleniyor")cP++;
        else if(st==="tamamlandi")cD++;
        html+=renderRequestItem(docSnap.id,d);
      });
      requestsContainer.innerHTML=html;
      metricQueue.textContent=`Bekleyen talep: ${cQ}`;
      metricInProgress.textContent=`ƒ∞≈üleniyor: ${cP}`;
      metricCompleted.textContent=`Tamamlandƒ±: ${cD}`;
    });

    function statusBadgeClass(status){
      switch(status){
        case "hazirlaniyor":return "badge-status-hazirlaniyor";
        case "gonderiliyor":
        case "isleniyor":return "badge-status-gonderiliyor";
        case "kontrolde":return "badge-status-kontrol";
        case "tamamlandi":return "badge-status-tamamlandi";
        default:return "";
      }
    }
    function statusText(status){
      switch(status){
        case "hazirlaniyor":return "Hazƒ±rlanƒ±yor";
        case "gonderiliyor":
        case "isleniyor":return "G√∂nderiliyor / ƒ∞≈üleniyor";
        case "kontrolde":return "Y√∂netici kontrol√ºnde";
        case "tamamlandi":return "Tamamlandƒ±";
        default:return "Bilinmiyor";
      }
    }
    function renderRequestItem(id,d){
      const createdAt=d.createdAt?.toDate ? d.createdAt.toDate():null;
      let timeText="";
      if(createdAt){
        timeText=`${two(createdAt.getDate())}.${two(createdAt.getMonth()+1)} ‚Ä¢ ${two(createdAt.getHours())}:${two(createdAt.getMinutes())}`;
      }else timeText="Tarih bekleniyor...";

      const stClass=statusBadgeClass(d.status);
      const stText=statusText(d.status);
      const role=d.userRole||"user";
      const roleChip=role==="vip"
        ? `<span class="badge" style="border-color:rgba(250,204,21,0.8);background:rgba(250,204,21,0.08);color:#facc15;">VIP</span>`
        : "";

      return `
        <div class="request-item">
          <div>
            <div class="request-meta">
              <span class="badge badge-platform">${d.platform||"-"} ‚Ä¢ ${d.serviceType||"-"}</span>
              <span class="badge">Adet: ${d.quantity||"-"}</span>
              <span class="badge">√ñncelik: ${d.priority||"Normal"}</span>
              ${roleChip}
            </div>
            ${d.notes ? `<div class="request-notes">${d.notes}</div>` : ""}
          </div>
          <div class="request-link">
            <div class="small-label">Link</div>
            <a href="${d.link}" target="_blank" rel="noopener noreferrer">${d.link}</a>
            <div class="small-label" style="margin-top:6px;">Talep sahibi</div>
            <div>${d.userName||"Bilinmiyor"}</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
            <span class="badge ${stClass}">${stText}</span>
            <div class="request-time">${timeText}</div>
          </div>
        </div>
      `;
    }

    // Ayarlar / duyuru
    const serverStatusPill=document.getElementById("serverStatusPill");
    const serverStatusText=document.getElementById("serverStatusText");
    const announcementBox=document.getElementById("announcementBox");
    const announcementTitle=document.getElementById("announcementTitle");
    const announcementText=document.getElementById("announcementText");
    const announcementUpdated=document.getElementById("announcementUpdated");

    async function loadSettings(){
      try{
        const snap=await getDoc(settingsDocRef);
        if(!snap.exists()){
          announcementBox.style.display="none";
          serverStatusText.textContent="Durum bilinmiyor";
          serverStatusPill.classList.add("offline");
          return;
        }
        const data=snap.data();
        const status=data.serverStatus||"offline";
        const msg=data.serverStatusMessage||"";
        if(status==="online"){
          serverStatusPill.classList.remove("offline");
          serverStatusText.textContent=msg||"Sunucu aktif";
        }else if(status==="maintenance"){
          serverStatusPill.classList.add("offline");
          serverStatusText.textContent=msg||"Sunucu bakƒ±mda";
        }else{
          serverStatusPill.classList.add("offline");
          serverStatusText.textContent=msg||"Sunucu offline / bakƒ±mda";
        }
        if(data.announcementText){
          announcementBox.style.display="flex";
          announcementTitle.textContent=data.announcementTitle||"Duyuru";
          announcementText.textContent=data.announcementText;
          if(data.announcementUpdatedAt?.toDate){
            const dt=data.announcementUpdatedAt.toDate();
            announcementUpdated.textContent=`G√ºncellendi: ${two(dt.getDate())}.${two(dt.getMonth()+1)} ‚Ä¢ ${two(dt.getHours())}:${two(dt.getMinutes())}`;
          }else announcementUpdated.textContent="";
        }else{
          announcementBox.style.display="none";
        }
      }catch(err){
        console.error("Ayarlar okunamadƒ±",err);
        serverStatusText.textContent="Durum okunamadƒ±";
        serverStatusPill.classList.add("offline");
      }
    }
    loadSettings();

    // Admƒ∞ne √∂zel mesaj g√∂nderme
    const adminMessageForm = document.getElementById("adminMessageForm");
    const msgSubjectInput = document.getElementById("msgSubject");
    const msgBodyInput = document.getElementById("msgBody");
    const msgError = document.getElementById("msgError");
    const msgSuccess = document.getElementById("msgSuccess");
    const msgSendBtn = document.getElementById("msgSendBtn");

    if (adminMessageForm) {
      adminMessageForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        msgError.style.display = "none";
        msgSuccess.style.display = "none";

        if (!currentUser.id) {
          msgError.textContent = "√ñnce isminle sisteme giri≈ü yapmalƒ±sƒ±n.";
          msgError.style.display = "block";
          loginOverlay.style.display = "flex";
          return;
        }

        const subject = msgSubjectInput.value.trim();
        const body = msgBodyInput.value.trim();

        if (!body) {
          msgError.textContent = "Mesaj alanƒ± bo≈ü olamaz.";
          msgError.style.display = "block";
          return;
        }

        msgSendBtn.disabled = true;
        msgSendBtn.textContent = "G√∂nderiliyor...";

        try {
          await addDoc(adminMessagesCol, {
            userId: currentUser.id,
            userName: currentUser.name,
            subject,
            message: body,
            status: "unread",
            createdAt: serverTimestamp()
          });
          msgSubjectInput.value = "";
          msgBodyInput.value = "";
          msgSuccess.style.display = "block";
        } catch (err) {
          console.error("Mesaj g√∂nderim hata:", err);
          msgError.textContent = "Mesaj g√∂nderilirken bir hata olu≈ütu.";
          msgError.style.display = "block";
        } finally {
          msgSendBtn.disabled = false;
          msgSendBtn.textContent = "üì© Mesajƒ± G√∂nder";
        }
      });
    }
  </script>
</body>
</html>
